<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ–‡ä»¶æƒæå·¥å…· - iStore</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 100px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .upload-section {
            background: #3a4a5c;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .upload-btn {
            width: 100%;
            padding: 16px;
            background: #5a6c7d;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
        }

        .upload-btn:active {
            transform: scale(0.98);
            background: #4a5c6d;
        }

        #fileInput {
            display: none;
        }

        .controls {
            background: #3a4a5c;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            display: none;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group:last-child {
            margin-bottom: 0;
        }

        .control-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #e8e8e8;
            margin-bottom: 8px;
        }

        .control-group input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #4a5a6c;
            outline: none;
            -webkit-appearance: none;
        }

        .control-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #7b8a9d;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
        }

        .control-value {
            display: inline-block;
            background: #4a5a6c;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 14px;
            color: #d0d0d0;
            margin-left: 10px;
        }

        .filename-section {
            background: #3a4a5c;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            display: none;
        }

        .filename-section label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #e8e8e8;
            margin-bottom: 8px;
        }

        .filename-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .filename-section input[type="text"] {
            flex: 1;
            padding: 12px;
            border: 2px solid #4a5a6c;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
            background: #2c3844;
            color: #e8e8e8;
        }

        .filename-section input[type="text"]:focus {
            border-color: #7b8a9d;
        }

        .filename-section input[type="text"]::placeholder {
            color: #8a9aa8;
        }

        .ocr-status {
            font-size: 12px;
            color: #a0a0a0;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .ocr-status.loading {
            color: #7b8a9d;
        }

        .ocr-status.success {
            color: #5fb878;
        }

        .ocr-status.error {
            color: #ffb74d;
        }

        .sort-hint {
            background: #3a4a5c;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            display: none;
            text-align: center;
            color: #a0a0a0;
            font-size: 14px;
        }

        .sort-hint.show {
            display: block;
        }

        .preview-section {
            display: none;
        }

        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .preview-item {
            background: #3a4a5c;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 12px rgba(0,0,0,0.3);
            position: relative;
        }

        .preview-item img {
            width: 100%;
            height: auto;
            display: block;
        }

        .preview-item .page-number {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        .preview-item .mask-badge {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(95, 184, 120, 0.9);
            color: white;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            max-width: 90%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .preview-item .controls-overlay {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .preview-item .move-btn,
        .preview-item .delete-btn {
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
            transition: all 0.3s;
        }

        .preview-item .move-btn:active,
        .preview-item .delete-btn:active {
            transform: scale(0.95);
        }

        .preview-item .delete-btn {
            background: #e74c3c;
        }

        .preview-item .move-btn.up {
            background: #5a6c7d;
        }

        .preview-item .move-btn.down {
            background: #5a6c7d;
        }

        .preview-item .move-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* ç¬¬ä¸€å¼µé è¦½åœ–ä¸‹æ–¹çš„é®è”½æ§åˆ¶ */
        .first-image-mask-controls {
            background: #2c3844;
            border-radius: 0 0 12px 12px;
            padding: 16px;
            margin-top: -12px;
            display: none;
        }

        .first-image-mask-controls.show {
            display: block;
        }

        .first-image-mask-controls .mini-title {
            font-size: 12px;
            font-weight: 600;
            color: #5fb878;
            margin-bottom: 12px;
            text-align: center;
        }

        .first-image-mask-controls .control-group {
            margin-bottom: 12px;
        }

        .first-image-mask-controls .control-group:last-child {
            margin-bottom: 0;
        }

        .first-image-mask-controls .control-group label {
            font-size: 12px;
            color: #d0d0d0;
        }

        .first-image-mask-controls .control-value {
            font-size: 12px;
            padding: 2px 8px;
        }

        .generate-btn {
            width: 100%;
            padding: 16px;
            background: #5fb878;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
            box-shadow: 0 4px 20px rgba(95, 184, 120, 0.3);
        }

        .generate-btn:active {
            transform: scale(0.98);
            background: #4fa768;
        }

        .generate-btn:disabled {
            background: #5a6c7d;
            cursor: not-allowed;
            box-shadow: none;
        }

        .stats {
            text-align: center;
            color: white;
            margin-bottom: 20px;
            font-size: 16px;
            font-weight: 500;
        }

        .download-tip {
            background: #3a4a5c;
            border-radius: 16px;
            padding: 16px;
            margin-top: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            display: none;
            color: #a0a0a0;
            font-size: 13px;
            line-height: 1.6;
        }

        .download-tip.show {
            display: block;
        }

        .download-tip strong {
            color: #e8e8e8;
            display: block;
            margin-bottom: 8px;
        }

        @media (max-width: 600px) {
            .preview-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“„ æ–‡ä»¶æƒæå·¥å…·</h1>
            <p>iStore Taiwan - æ™ºèƒ½ç™¼ç¥¨æƒæç³»çµ±</p>
        </div>

        <div class="upload-section">
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                <span>ğŸ“·</span>
                <span>é¸æ“‡ç…§ç‰‡</span>
            </button>
            <input type="file" id="fileInput" accept="image/*" multiple>
        </div>

        <div class="filename-section" id="filenameSection">
            <label>ğŸ“ PDF æª”æ¡ˆåç¨±</label>
            <div class="filename-input-group">
                <input type="text" id="filenameInput" placeholder="è‡ªå‹•è¾¨è­˜ä¸­...">
            </div>
            <div class="ocr-status" id="ocrStatus"></div>
        </div>

        <div class="sort-hint" id="sortHint">
            ğŸ“‹ ç¬¬1å¼µåºè™Ÿèˆ‡åº•éƒ¨é®è”½ / ç¬¬4å¼µåºè™Ÿé®è”½ - å¯ä½¿ç”¨ â†‘â†“ èª¿æ•´é †åº
        </div>

        <div class="controls" id="controls">
            <div class="control-group">
                <label>
                    å°æ¯”åº¦
                    <span class="control-value" id="contrastValue">150%</span>
                </label>
                <input type="range" id="contrast" min="100" max="200" value="150" step="10">
            </div>
            <div class="control-group">
                <label>
                    äº®åº¦
                    <span class="control-value" id="brightnessValue">110%</span>
                </label>
                <input type="range" id="brightness" min="80" max="140" value="110" step="5">
            </div>
        </div>

        <div class="preview-section" id="previewSection">
            <div class="stats" id="stats"></div>
            <div class="preview-grid" id="previewGrid"></div>
            <button class="generate-btn" id="generateBtn">
                <span>ğŸ“¥</span>
                <span>ç”Ÿæˆ PDF</span>
            </button>
            <div class="download-tip" id="downloadTip">
                <strong>ğŸ’¡ iOS ä¸‹è¼‰æç¤ºï¼š</strong>
                é»æ“Šã€Œç”Ÿæˆ PDFã€å¾Œï¼Œæª”æ¡ˆæœƒè‡ªå‹•ä¸‹è¼‰ã€‚è«‹åˆ° Safari çš„ã€Œä¸‹è¼‰é …ç›®ã€(â†“) æŸ¥çœ‹ï¼Œæª”åæœƒæ˜¯ä½ è¨­å®šçš„ç™¼ç¥¨è™Ÿç¢¼ã€‚
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script>
        let images = [];
        let processedImages = [];
        let detectedFilename = '';
        let serialNumbers = [];

        const fileInput = document.getElementById('fileInput');
        const previewGrid = document.getElementById('previewGrid');
        const previewSection = document.getElementById('previewSection');
        const controls = document.getElementById('controls');
        const filenameSection = document.getElementById('filenameSection');
        const filenameInput = document.getElementById('filenameInput');
        const generateBtn = document.getElementById('generateBtn');
        const stats = document.getElementById('stats');
        const ocrStatus = document.getElementById('ocrStatus');
        const sortHint = document.getElementById('sortHint');
        const downloadTip = document.getElementById('downloadTip');
        
        const contrastSlider = document.getElementById('contrast');
        const brightnessSlider = document.getElementById('brightness');
        const contrastValue = document.getElementById('contrastValue');
        const brightnessValue = document.getElementById('brightnessValue');

        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

        fileInput.addEventListener('change', handleFileSelect);
        contrastSlider.addEventListener('input', updateImageControls);
        brightnessSlider.addEventListener('input', updateImageControls);
        generateBtn.addEventListener('click', generatePDF);

        async function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;

            images = [];
            processedImages = [];
            serialNumbers = [];
            
            for (const file of files) {
                await loadImage(file);
            }
            
            if (images.length >= 1) {
                await detectFirstImageSerial();
            }
            
            processAllImages();
            updateStats();
            controls.style.display = 'block';
            filenameSection.style.display = 'block';
            previewSection.style.display = 'block';
            sortHint.classList.add('show');
            
            if (isIOS) {
                downloadTip.classList.add('show');
            }
            
            await performOCR();
        }

        function loadImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        images.push(img);
                        resolve();
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        async function detectFirstImageSerial() {
            console.log('é–‹å§‹è¾¨è­˜ç¬¬ä¸€å¼µåœ–ç‰‡çš„åºè™Ÿ...');
            
            try {
                const img = images[0];
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                const cropX = Math.floor(img.width * 0.15);
                const cropY = Math.floor(img.height * 0.235);
                const cropWidth = Math.floor(img.width * 0.7);
                const cropHeight = Math.floor(img.height * 0.04);
                
                canvas.width = cropWidth;
                canvas.height = cropHeight;
                
                ctx.drawImage(img, cropX, cropY, cropWidth, cropHeight, 0, 0, cropWidth, cropHeight);
                
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                
                for (let i = 0; i < data.length; i += 4) {
                    let gray = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
                    gray = ((gray - 128) * 2.0) + 128;
                    gray = Math.max(0, Math.min(255, gray));
                    data[i] = data[i + 1] = data[i + 2] = gray;
                }
                
                ctx.putImageData(imageData, 0, 0);
                
                const result = await Tesseract.recognize(canvas, 'eng', { logger: () => {} });
                const text = result.data.text.replace(/\s/g, '');
                
                console.log('ç¬¬ä¸€å¼µåœ–ç‰‡åºè™Ÿå€åŸŸ OCR çµæœ:', text);
                
                const serialPattern = /[A-Z0-9]{10}/gi;
                const matches = text.match(serialPattern);
                
                if (matches && matches.length > 0) {
                    serialNumbers[0] = matches.join(', ');
                    console.log('âœ“ æ‰¾åˆ°åºè™Ÿ:', serialNumbers[0]);
                } else {
                    serialNumbers[0] = null;
                    console.log('âœ— æœªæ‰¾åˆ°åºè™Ÿ');
                }
                
            } catch (error) {
                console.error('ç¬¬ä¸€å¼µåœ–ç‰‡åºè™Ÿè¾¨è­˜å¤±æ•—:', error);
                serialNumbers[0] = null;
            }
        }

        async function performOCR() {
            if (images.length === 0) return;
            
            ocrStatus.className = 'ocr-status loading';
            ocrStatus.innerHTML = 'ğŸ” æ­£åœ¨è¾¨è­˜ç™¼ç¥¨è™Ÿç¢¼...';
            filenameInput.value = '';
            
            try {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = images[0];
                
                const cropWidth = Math.floor(img.width * 0.4);
                const cropHeight = Math.floor(img.height * 0.15);
                const cropX = img.width - cropWidth;
                const cropY = 0;
                
                canvas.width = cropWidth;
                canvas.height = cropHeight;
                
                ctx.drawImage(img, cropX, cropY, cropWidth, cropHeight, 0, 0, cropWidth, cropHeight);
                
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                
                for (let i = 0; i < data.length; i += 4) {
                    let gray = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
                    gray = ((gray - 128) * 1.5) + 128;
                    gray = Math.max(0, Math.min(255, gray));
                    data[i] = data[i + 1] = data[i + 2] = gray;
                }
                
                ctx.putImageData(imageData, 0, 0);
                
                const result = await Tesseract.recognize(
                    canvas,
                    'eng',
                    {
                        logger: m => {
                            if (m.status === 'recognizing text') {
                                const progress = Math.round(m.progress * 100);
                                ocrStatus.innerHTML = `ğŸ” è¾¨è­˜ä¸­... ${progress}%`;
                            }
                        }
                    }
                );
                
                const text = result.data.text.replace(/\s/g, '');
                console.log('ç™¼ç¥¨ OCR åŸå§‹çµæœ:', text);
                
                const patterns = [
                    /[A-Z]{2}-?\d{8}/gi,
                    /[A-Z0]{2}-?\d{8}/gi,
                    /[A-Z]{1}[A-Z0]{1}-?\d{8}/gi
                ];
                
                let matches = null;
                for (const pattern of patterns) {
                    matches = text.match(pattern);
                    if (matches && matches.length > 0) break;
                }
                
                if (matches && matches.length > 0) {
                    let invoiceNum = matches[0].replace(/-/g, '');
                    invoiceNum = invoiceNum.replace(/0([A-Z])/g, 'O$1');
                    invoiceNum = invoiceNum.replace(/([A-Z])0/g, '$1O');
                    
                    if (invoiceNum.length >= 10) {
                        const prefix = invoiceNum.substring(0, 2).toUpperCase();
                        const numbers = invoiceNum.substring(2, 10);
                        detectedFilename = `${prefix}-${numbers}`;
                        
                        filenameInput.value = detectedFilename;
                        ocrStatus.className = 'ocr-status success';
                        ocrStatus.innerHTML = `âœ… å·²è¾¨è­˜ç™¼ç¥¨è™Ÿç¢¼: ${detectedFilename}`;
                    } else {
                        throw new Error('æ ¼å¼ä¸ç¬¦');
                    }
                } else {
                    throw new Error('æœªæ‰¾åˆ°ç™¼ç¥¨è™Ÿç¢¼');
                }
            } catch (error) {
                console.error('OCR Error:', error);
                const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                detectedFilename = `æƒææ–‡ä»¶_${timestamp}`;
                filenameInput.value = detectedFilename;
                ocrStatus.className = 'ocr-status error';
                ocrStatus.innerHTML = 'âš ï¸ æœªæ‰¾åˆ°ç™¼ç¥¨è™Ÿç¢¼ï¼Œè«‹æ‰‹å‹•è¼¸å…¥æˆ–ä½¿ç”¨é è¨­åç¨±';
            }
        }

        function processAllImages() {
            processedImages = images.map((img, index) => processImage(img, index));
            displayPreviews();
        }

        function processImage(img, index) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = img.width;
            canvas.height = img.height;
            
            ctx.drawImage(img, 0, 0);
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            const contrast = parseFloat(contrastSlider.value) / 100;
            const brightness = parseFloat(brightnessSlider.value) / 100;
            
            for (let i = 0; i < data.length; i += 4) {
                let gray = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
                
                gray = gray * brightness;
                gray = ((gray - 128) * contrast) + 128;
                gray = Math.max(0, Math.min(255, gray));
                
                data[i] = gray;
                data[i + 1] = gray;
                data[i + 2] = gray;
            }
            
            ctx.putImageData(imageData, 0, 0);
            
            if (index === 0) {
                const serialPosSlider = document.getElementById('serialPos');
                const serialHeightSlider = document.getElementById('serialHeight');
                
                const serialPosPercent = serialPosSlider ? parseFloat(serialPosSlider.value) / 100 : 0.235;
                const serialHeightPercent = serialHeightSlider ? parseFloat(serialHeightSlider.value) / 100 : 0.04;
                
                const serialX = Math.floor(canvas.width * 0.15);
                const serialY = Math.floor(canvas.height * serialPosPercent);
                const serialWidth = Math.floor(canvas.width * 0.7);
                const serialHeight = Math.floor(canvas.height * serialHeightPercent);
                
                ctx.fillStyle = 'white';
                ctx.fillRect(serialX, serialY, serialWidth, serialHeight);
                
                const maskHeight = Math.floor(canvas.height * 0.1);
                const maskY = canvas.height - maskHeight;
                ctx.fillRect(0, maskY, canvas.width, maskHeight);
                
                console.log('âœ“ ç¬¬1å¼µå·²é®è”½åºè™Ÿæ¬„ä½å’Œåº•éƒ¨');
            }
            
            if (index === 3) {
                const maskX = Math.floor(canvas.width * 0.15);
                const maskY = Math.floor(canvas.height * 0.42);
                const maskWidth = Math.floor(canvas.width * 0.7);
                const maskHeight = Math.floor(canvas.height * 0.08);
                
                ctx.fillStyle = 'white';
                ctx.fillRect(maskX, maskY, maskWidth, maskHeight);
                
                console.log('âœ“ ç¬¬4å¼µå·²é®è”½åºè™Ÿå€åŸŸ');
            }
            
            return canvas.toDataURL('image/jpeg', 0.9);
        }

        function displayPreviews() {
            previewGrid.innerHTML = '';
            processedImages.forEach((dataUrl, index) => {
                const div = document.createElement('div');
                div.className = 'preview-item';
                
                let maskBadge = '';
                if (index === 0) {
                    const serialText = serialNumbers[0] ? `: ${serialNumbers[0]}` : '';
                    maskBadge = `<div class="mask-badge">âœ“ åºè™Ÿèˆ‡åº•éƒ¨å·²é®è”½${serialText}</div>`;
                } else if (index === 3) {
                    maskBadge = '<div class="mask-badge">âœ“ åºè™Ÿå·²é®è”½</div>';
                }
                
                div.innerHTML = `
                    <div class="page-number">ç¬¬ ${index + 1} é </div>
                    ${maskBadge}
                    <div class="controls-overlay">
                        <button class="move-btn up" onclick="moveImage(${index}, -1)" ${index === 0 ? 'disabled' : ''}>â†‘</button>
                        <button class="delete-btn" onclick="deleteImage(${index})">Ã—</button>
                        <button class="move-btn down" onclick="moveImage(${index}, 1)" ${index === images.length - 1 ? 'disabled' : ''}>â†“</button>
                    </div>
                    <img src="${dataUrl}" alt="Page ${index + 1}">
                `;
                
                // å¦‚æœæ˜¯ç¬¬ä¸€å¼µåœ–ç‰‡ï¼ŒåŠ å…¥é®è”½èª¿æ•´æ§åˆ¶
                if (index === 0) {
                    const maskControls = document.createElement('div');
                    maskControls.className = 'first-image-mask-controls show';
                    maskControls.innerHTML = `
                        <div class="mini-title">ğŸ¯ èª¿æ•´ç¬¬ä¸€å¼µé®è”½ä½ç½®</div>
                        <div class="control-group">
                            <label>
                                åºè™Ÿæ¬„ä½ä½ç½®ï¼ˆä¸Šä¸‹ï¼‰
                                <span class="control-value" id="serialPosValue">23.5%</span>
                            </label>
                            <input type="range" id="serialPos" min="15" max="35" value="23.5" step="0.5">
                        </div>
                        <div class="control-group">
                            <label>
                                åºè™Ÿæ¬„ä½é«˜åº¦
                                <span class="control-value" id="serialHeightValue">4%</span>
                            </label>
                            <input type="range" id="serialHeight" min="2" max="8" value="4" step="0.5">
                        </div>
                    `;
                    div.appendChild(maskControls);
                    
                    // ç¶å®šäº‹ä»¶
                    setTimeout(() => {
                        const serialPosSlider = document.getElementById('serialPos');
                        const serialHeightSlider = document.getElementById('serialHeight');
                        const serialPosValue = document.getElementById('serialPosValue');
                        const serialHeightValue = document.getElementById('serialHeightValue');
                        
                        if (serialPosSlider) {
                            serialPosSlider.addEventListener('input', () => {
                                serialPosValue.textContent = serialPosSlider.value + '%';
                                processAllImages();
                            });
                        }
                        
                        if (serialHeightSlider) {
                            serialHeightSlider.addEventListener('input', () => {
                                serialHeightValue.textContent = serialHeightSlider.value + '%';
                                processAllImages();
                            });
                        }
                    }, 0);
                }
                
                previewGrid.appendChild(div);
            });
        }

        function moveImage(index, direction) {
            const newIndex = index + direction;
            
            if (newIndex < 0 || newIndex >= images.length) return;
            
            [images[index], images[newIndex]] = [images[newIndex], images[index]];
            [serialNumbers[index], serialNumbers[newIndex]] = [serialNumbers[newIndex], serialNumbers[index]];
            
            processAllImages();
            updateStats();
        }

        function deleteImage(index) {
            images.splice(index, 1);
            processedImages.splice(index, 1);
            serialNumbers.splice(index, 1);
            
            if (images.length > 0) {
                processAllImages();
            }
            
            updateStats();
            
            if (images.length === 0) {
                previewSection.style.display = 'none';
                controls.style.display = 'none';
                filenameSection.style.display = 'none';
                sortHint.classList.remove('show');
                downloadTip.classList.remove('show');
            }
        }

        function updateImageControls() {
            contrastValue.textContent = contrastSlider.value + '%';
            brightnessValue.textContent = brightnessSlider.value + '%';
            processAllImages();
        }

        function updateStats() {
            stats.textContent = `ğŸ“„ å…± ${images.length} é æ–‡ä»¶`;
        }

        async function generatePDF() {
            if (processedImages.length === 0) return;
            
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<span>â³</span><span>ç”Ÿæˆä¸­...</span>';
            
            const { jsPDF } = window.jspdf;
            
            const a4Width = 210;
            const a4Height = 297;
            
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });
            
            for (let i = 0; i < processedImages.length; i++) {
                if (i > 0) {
                    pdf.addPage();
                }
                
                const img = new Image();
                img.src = processedImages[i];
                
                await new Promise(resolve => {
                    img.onload = resolve;
                });
                
                const imgWidth = img.width;
                const imgHeight = img.height;
                const imgRatio = imgWidth / imgHeight;
                const a4Ratio = a4Width / a4Height;
                
                let finalWidth, finalHeight, xOffset, yOffset;
                
                if (imgRatio > a4Ratio) {
                    finalWidth = a4Width;
                    finalHeight = a4Width / imgRatio;
                    xOffset = 0;
                    yOffset = (a4Height - finalHeight) / 2;
                } else {
                    finalHeight = a4Height;
                    finalWidth = a4Height * imgRatio;
                    xOffset = (a4Width - finalWidth) / 2;
                    yOffset = 0;
                }
                
                pdf.addImage(processedImages[i], 'JPEG', xOffset, yOffset, finalWidth, finalHeight);
            }
            
            let filename = filenameInput.value.trim() || detectedFilename || 'æƒææ–‡ä»¶';
            filename = filename.replace(/[<>:"/\\|?*]/g, '_');
            
            try {
                const pdfBlob = pdf.output('blob');
                const url = URL.createObjectURL(pdfBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `${filename}.pdf`;
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                setTimeout(() => {
                    URL.revokeObjectURL(url);
                }, 100);
                
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<span>âœ…</span><span>å®Œæˆï¼</span>';
            } catch (error) {
                console.error('Download error:', error);
                pdf.save(`${filename}.pdf`);
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<span>âœ…</span><span>å®Œæˆï¼</span>';
            }
            
            setTimeout(() => {
                generateBtn.innerHTML = '<span>ğŸ“¥</span><span>ç”Ÿæˆ PDF</span>';
            }, 2000);
        }
    </script>
</body>
</html>
