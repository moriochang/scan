<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ–‡ä»¶æƒæå·¥å…· - iStore</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 100px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .upload-section {
            background: #3a4a5c;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .upload-btn {
            width: 100%;
            padding: 16px;
            background: #5a6c7d;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
        }

        .upload-btn:active {
            transform: scale(0.98);
            background: #4a5c6d;
        }

        #fileInput {
            display: none;
        }

        .controls {
            background: #3a4a5c;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            display: none;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group:last-child {
            margin-bottom: 0;
        }

        .control-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #e8e8e8;
            margin-bottom: 8px;
        }

        .control-group input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #4a5a6c;
            outline: none;
            -webkit-appearance: none;
        }

        .control-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #7b8a9d;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
        }

        .control-value {
            display: inline-block;
            background: #4a5a6c;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 14px;
            color: #d0d0d0;
            margin-left: 10px;
        }

        .filename-section {
            background: #3a4a5c;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            display: none;
        }

        .filename-section label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #e8e8e8;
            margin-bottom: 8px;
        }

        .filename-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .filename-section input[type="text"] {
            flex: 1;
            padding: 12px;
            border: 2px solid #4a5a6c;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
            background: #2c3844;
            color: #e8e8e8;
        }

        .filename-section input[type="text"]:focus {
            border-color: #7b8a9d;
        }

        .filename-section input[type="text"]::placeholder {
            color: #8a9aa8;
        }

        .ocr-status {
            font-size: 12px;
            color: #a0a0a0;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .ocr-status.loading {
            color: #7b8a9d;
        }

        .ocr-status.success {
            color: #5fb878;
        }

        .ocr-status.error {
            color: #ffb74d;
        }

        .preview-section {
            display: none;
        }

        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .preview-item {
            background: #3a4a5c;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 12px rgba(0,0,0,0.3);
            position: relative;
        }

        .preview-item img {
            width: 100%;
            height: auto;
            display: block;
        }

        .preview-item .page-number {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        .preview-item .delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #e74c3c;
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
        }

        .generate-btn {
            width: 100%;
            padding: 16px;
            background: #5fb878;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
            box-shadow: 0 4px 20px rgba(95, 184, 120, 0.3);
        }

        .generate-btn:active {
            transform: scale(0.98);
            background: #4fa768;
        }

        .generate-btn:disabled {
            background: #5a6c7d;
            cursor: not-allowed;
            box-shadow: none;
        }

        .stats {
            text-align: center;
            color: white;
            margin-bottom: 20px;
            font-size: 16px;
            font-weight: 500;
        }

        @media (max-width: 600px) {
            .preview-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“„ æ–‡ä»¶æƒæå·¥å…·</h1>
            <p>iStore Taiwan - æ™ºèƒ½ç™¼ç¥¨æƒæç³»çµ±</p>
        </div>

        <div class="upload-section">
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                <span>ğŸ“·</span>
                <span>é¸æ“‡ç…§ç‰‡</span>
            </button>
            <input type="file" id="fileInput" accept="image/*" multiple>
        </div>

        <div class="filename-section" id="filenameSection">
            <label>ğŸ“ PDF æª”æ¡ˆåç¨±</label>
            <div class="filename-input-group">
                <input type="text" id="filenameInput" placeholder="è‡ªå‹•è¾¨è­˜ä¸­...">
            </div>
            <div class="ocr-status" id="ocrStatus"></div>
        </div>

        <div class="controls" id="controls">
            <div class="control-group">
                <label>
                    å°æ¯”åº¦
                    <span class="control-value" id="contrastValue">150%</span>
                </label>
                <input type="range" id="contrast" min="100" max="200" value="150" step="10">
            </div>
            <div class="control-group">
                <label>
                    äº®åº¦
                    <span class="control-value" id="brightnessValue">110%</span>
                </label>
                <input type="range" id="brightness" min="80" max="140" value="110" step="5">
            </div>
        </div>

        <div class="preview-section" id="previewSection">
            <div class="stats" id="stats"></div>
            <div class="preview-grid" id="previewGrid"></div>
            <button class="generate-btn" id="generateBtn">
                <span>ğŸ“¥</span>
                <span>ç”Ÿæˆ PDF</span>
            </button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script>
        let images = [];
        let processedImages = [];
        let detectedFilename = '';

        const fileInput = document.getElementById('fileInput');
        const previewGrid = document.getElementById('previewGrid');
        const previewSection = document.getElementById('previewSection');
        const controls = document.getElementById('controls');
        const filenameSection = document.getElementById('filenameSection');
        const filenameInput = document.getElementById('filenameInput');
        const generateBtn = document.getElementById('generateBtn');
        const stats = document.getElementById('stats');
        const ocrStatus = document.getElementById('ocrStatus');
        const contrastSlider = document.getElementById('contrast');
        const brightnessSlider = document.getElementById('brightness');
        const contrastValue = document.getElementById('contrastValue');
        const brightnessValue = document.getElementById('brightnessValue');

        fileInput.addEventListener('change', handleFileSelect);
        contrastSlider.addEventListener('input', updateControls);
        brightnessSlider.addEventListener('input', updateControls);
        generateBtn.addEventListener('click', generatePDF);

        async function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;

            images = [];
            processedImages = [];
            
            await Promise.all(files.map(file => loadImage(file)));
            processAllImages();
            updateStats();
            controls.style.display = 'block';
            filenameSection.style.display = 'block';
            previewSection.style.display = 'block';
            
            // é€²è¡Œ OCR è¾¨è­˜
            await performOCR();
        }

        function loadImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        images.push(img);
                        resolve();
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        async function performOCR() {
            if (images.length === 0) return;
            
            ocrStatus.className = 'ocr-status loading';
            ocrStatus.innerHTML = 'ğŸ” æ­£åœ¨è¾¨è­˜ç™¼ç¥¨è™Ÿç¢¼...';
            filenameInput.value = '';
            
            try {
                // ä½¿ç”¨ç¬¬ä¸€å¼µåœ–ç‰‡é€²è¡Œ OCRï¼Œåªæ“·å–å³ä¸Šè§’å€åŸŸ
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = images[0];
                
                // æ“·å–å³ä¸Šè§’å€åŸŸ (ç´„ 40% å¯¬åº¦ï¼Œ15% é«˜åº¦)
                const cropWidth = Math.floor(img.width * 0.4);
                const cropHeight = Math.floor(img.height * 0.15);
                const cropX = img.width - cropWidth;
                const cropY = 0;
                
                canvas.width = cropWidth;
                canvas.height = cropHeight;
                
                // ç¹ªè£½æ“·å–å€åŸŸ
                ctx.drawImage(img, cropX, cropY, cropWidth, cropHeight, 0, 0, cropWidth, cropHeight);
                
                // å¢å¼·å°æ¯”åº¦ä»¥æé«˜ OCR æº–ç¢ºåº¦
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                
                for (let i = 0; i < data.length; i += 4) {
                    let gray = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
                    gray = ((gray - 128) * 1.5) + 128;
                    gray = Math.max(0, Math.min(255, gray));
                    data[i] = data[i + 1] = data[i + 2] = gray;
                }
                
                ctx.putImageData(imageData, 0, 0);
                
                const result = await Tesseract.recognize(
                    canvas,
                    'eng',
                    {
                        logger: m => {
                            if (m.status === 'recognizing text') {
                                const progress = Math.round(m.progress * 100);
                                ocrStatus.innerHTML = `ğŸ” è¾¨è­˜ä¸­... ${progress}%`;
                            }
                        }
                    }
                );
                
                // åœ¨è¾¨è­˜çµæœä¸­å°‹æ‰¾ç™¼ç¥¨è™Ÿç¢¼æ ¼å¼
                const text = result.data.text.replace(/\s/g, '');
                console.log('OCR åŸå§‹çµæœ:', text);
                
                // åŒ¹é…å„ç¨®å¯èƒ½çš„æ ¼å¼ï¼š
                // UC-83319382, UC83319382, 0C-83319382 (Oè¢«èª¤èªç‚º0)
                const patterns = [
                    /[A-Z]{2}-?\d{8}/gi,           // æ¨™æº–æ ¼å¼
                    /[A-Z0]{2}-?\d{8}/gi,          // å¯èƒ½æœ‰ O è¢«èª¤èªç‚º 0
                    /[A-Z]{1}[A-Z0]{1}-?\d{8}/gi   // ç¬¬äºŒå€‹å­—æ¯å¯èƒ½æ˜¯ O æˆ– 0
                ];
                
                let matches = null;
                for (const pattern of patterns) {
                    matches = text.match(pattern);
                    if (matches && matches.length > 0) break;
                }
                
                if (matches && matches.length > 0) {
                    // å–ç¬¬ä¸€å€‹åŒ¹é…ä¸¦æ ¼å¼åŒ–
                    let invoiceNum = matches[0].replace(/-/g, '');
                    
                    // ä¿®æ­£å¸¸è¦‹çš„ OCR èª¤èª
                    invoiceNum = invoiceNum.replace(/0([A-Z])/g, 'O$1'); // 0C -> OC
                    invoiceNum = invoiceNum.replace(/([A-Z])0/g, '$1O'); // C0 -> CO
                    
                    // ç¢ºä¿å‰å…©å€‹å­—å…ƒæ˜¯å­—æ¯
                    if (invoiceNum.length >= 10) {
                        const prefix = invoiceNum.substring(0, 2).toUpperCase();
                        const numbers = invoiceNum.substring(2, 10);
                        detectedFilename = `${prefix}-${numbers}`;
                        
                        filenameInput.value = detectedFilename;
                        ocrStatus.className = 'ocr-status success';
                        ocrStatus.innerHTML = `âœ… å·²è¾¨è­˜ç™¼ç¥¨è™Ÿç¢¼: ${detectedFilename}`;
                    } else {
                        throw new Error('æ ¼å¼ä¸ç¬¦');
                    }
                } else {
                    throw new Error('æœªæ‰¾åˆ°ç™¼ç¥¨è™Ÿç¢¼');
                }
            } catch (error) {
                console.error('OCR Error:', error);
                const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                detectedFilename = `æƒææ–‡ä»¶_${timestamp}`;
                filenameInput.value = detectedFilename;
                ocrStatus.className = 'ocr-status error';
                ocrStatus.innerHTML = 'âš ï¸ æœªæ‰¾åˆ°ç™¼ç¥¨è™Ÿç¢¼ï¼Œè«‹æ‰‹å‹•è¼¸å…¥æˆ–ä½¿ç”¨é è¨­åç¨±';
            }
        }

        function processAllImages() {
            processedImages = images.map(img => processImage(img));
            displayPreviews();
        }

        function processImage(img) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = img.width;
            canvas.height = img.height;
            
            ctx.drawImage(img, 0, 0);
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            const contrast = parseFloat(contrastSlider.value) / 100;
            const brightness = parseFloat(brightnessSlider.value) / 100;
            
            for (let i = 0; i < data.length; i += 4) {
                let gray = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
                
                gray = gray * brightness;
                gray = ((gray - 128) * contrast) + 128;
                gray = Math.max(0, Math.min(255, gray));
                
                data[i] = gray;
                data[i + 1] = gray;
                data[i + 2] = gray;
            }
            
            ctx.putImageData(imageData, 0, 0);
            return canvas.toDataURL('image/jpeg', 0.9);
        }

        function displayPreviews() {
            previewGrid.innerHTML = '';
            processedImages.forEach((dataUrl, index) => {
                const div = document.createElement('div');
                div.className = 'preview-item';
                div.innerHTML = `
                    <div class="page-number">ç¬¬ ${index + 1} é </div>
                    <button class="delete-btn" onclick="deleteImage(${index})">Ã—</button>
                    <img src="${dataUrl}" alt="Page ${index + 1}">
                `;
                previewGrid.appendChild(div);
            });
        }

        function deleteImage(index) {
            images.splice(index, 1);
            processedImages.splice(index, 1);
            displayPreviews();
            updateStats();
            
            if (images.length === 0) {
                previewSection.style.display = 'none';
                controls.style.display = 'none';
                filenameSection.style.display = 'none';
            }
        }

        function updateControls() {
            contrastValue.textContent = contrastSlider.value + '%';
            brightnessValue.textContent = brightnessSlider.value + '%';
            processAllImages();
        }

        function updateStats() {
            stats.textContent = `ğŸ“„ å…± ${images.length} é æ–‡ä»¶`;
        }

        async function generatePDF() {
            if (processedImages.length === 0) return;
            
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<span>â³</span><span>ç”Ÿæˆä¸­...</span>';
            
            const { jsPDF } = window.jspdf;
            
            // A4 å°ºå¯¸ (mm)
            const a4Width = 210;
            const a4Height = 297;
            
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });
            
            for (let i = 0; i < processedImages.length; i++) {
                if (i > 0) {
                    pdf.addPage();
                }
                
                const img = new Image();
                img.src = processedImages[i];
                
                await new Promise(resolve => {
                    img.onload = resolve;
                });
                
                const imgWidth = img.width;
                const imgHeight = img.height;
                const imgRatio = imgWidth / imgHeight;
                const a4Ratio = a4Width / a4Height;
                
                let finalWidth, finalHeight, xOffset, yOffset;
                
                if (imgRatio > a4Ratio) {
                    // åœ–ç‰‡è¼ƒå¯¬ï¼Œä»¥å¯¬åº¦ç‚ºæº–
                    finalWidth = a4Width;
                    finalHeight = a4Width / imgRatio;
                    xOffset = 0;
                    yOffset = (a4Height - finalHeight) / 2;
                } else {
                    // åœ–ç‰‡è¼ƒé«˜ï¼Œä»¥é«˜åº¦ç‚ºæº–
                    finalHeight = a4Height;
                    finalWidth = a4Height * imgRatio;
                    xOffset = (a4Width - finalWidth) / 2;
                    yOffset = 0;
                }
                
                pdf.addImage(processedImages[i], 'JPEG', xOffset, yOffset, finalWidth, finalHeight);
            }
            
            // ä½¿ç”¨è‡ªè¨‚æª”åæˆ–è¾¨è­˜çš„ç™¼ç¥¨è™Ÿç¢¼
            let filename = filenameInput.value.trim() || detectedFilename || 'æƒææ–‡ä»¶';
            
            // ç§»é™¤ä¸åˆæ³•çš„æª”åå­—å…ƒ
            filename = filename.replace(/[<>:"/\\|?*]/g, '_');
            
            pdf.save(`${filename}.pdf`);
            
            generateBtn.disabled = false;
            generateBtn.innerHTML = '<span>âœ…</span><span>å®Œæˆï¼</span>';
            
            setTimeout(() => {
                generateBtn.innerHTML = '<span>ğŸ“¥</span><span>ç”Ÿæˆ PDF</span>';
            }, 2000);
        }
    </script>
</body>
</html>
